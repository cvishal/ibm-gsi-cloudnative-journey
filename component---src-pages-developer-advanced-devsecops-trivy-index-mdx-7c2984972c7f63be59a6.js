(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{WXL5:function(e,n,t){"use strict";t.r(n),t.d(n,"_frontmatter",(function(){return r})),t.d(n,"default",(function(){return d}));t("91GP"),t("rGqo"),t("yt8O"),t("Btvt"),t("RW0V"),t("q1tI");var i=t("7ljp"),a=t("013z");t("T0C+"),t("qKvR");function l(){return(l=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)}var r={},o=function(e){return function(n){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(i.b)("div",n)}},b=o("PageDescription"),p=o("Tabs"),c=o("Tab"),s=o("BR"),u={_frontmatter:r},m=a.a;function d(e){var n=e.components,t=function(e,n){if(null==e)return{};var t,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)t=l[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,["components"]);return Object(i.b)(m,l({},u,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)(b,{mdxType:"PageDescription"},Object(i.b)("p",null,"Integrating Aquasec Trivy in in CICD Pipeline for DevSecOps")),Object(i.b)("h2",null,"Overview"),Object(i.b)("p",null,"DevSecOps ensures the security by doing Vulnerability scanning on the container images. There are several tools available for image scanning. "),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"Trivy")," is a Simple and Comprehensive Vulnerability Scanner for Containers, Suitable for CI."),Object(i.b)("p",null,"The more information on Trivy is available in ",Object(i.b)("a",l({parentName:"p"},{href:"https://github.com/aquasecurity/trivy"}),"https://github.com/aquasecurity/trivy")),Object(i.b)("h2",null,"Working with Trivy Commands"),Object(i.b)("h3",null,"Installation"),Object(i.b)("p",null,"Trivy installation is very simple. You can use homebrew on macOS to install"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ brew install aquasecurity/trivy/trivy\n")),Object(i.b)("h3",null,"Trivy Standalone Run"),Object(i.b)("p",null,"Trivy can be run as standalone in Desktop or in laptop ."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ trivy image [YOUR_IMAGE_NAME]\n\n\n$ trivy image python:3.4-alpine\n")),Object(i.b)("p",null,"Output"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"2020-06-23T23:11:07.297+0530    INFO    Detecting Alpine vulnerabilities...\n\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 15 (UNKNOWN: 0, LOW: 1, MEDIUM: 10, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-15903   | MEDIUM   |                   | 2.2.7-r1      | expat: heap-based buffer       |\n|         |                  |          |                   |               | over-read via crafted XML      |\n|         |                  |          |                   |               | input                          |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   | HIGH     | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| openssl | CVE-2019-1543    | MEDIUM   | 1.1.1a-r1         | 1.1.1b-r1     | openssl: ChaCha20-Poly1305     |\n|         |                  |          |                   |               | with long nonces               |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1549    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in fork()           |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1551    |          |                   | 1.1.1d-r2     | openssl: Integer overflow in   |\n|         |                  |          |                   |               | RSAZ modular exponentiation on |\n|         |                  |          |                   |               | x86_64                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1563    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in PKCS7_dataDecode |\n|         |                  |          |                   |               | and CMS_decrypt_set1_pkey      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-1967    |          |                   | 1.1.1g-r0     | openssl: Segmentation fault in |\n|         |                  |          |                   |               | SSL_check_chain causes denial  |\n|         |                  |          |                   |               | of service                     |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-1547    | LOW      |                   | 1.1.1d-r0     | openssl: side-channel weak     |\n|         |                  |          |                   |               | encryption vulnerability       |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    | HIGH     | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-16168   | MEDIUM   |                   | 3.28.0-r1     | sqlite: division by zero in    |\n|         |                  |          |                   |               | whereLoopAddBtreeIndex in      |\n|         |                  |          |                   |               | sqlite3.c                      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-19242   |          |                   | 3.28.0-r2     | sqlite: SQL injection in       |\n|         |                  |          |                   |               | sqlite3ExprCodeTarget in       |\n|         |                  |          |                   |               | expr.c                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-5018    |          |                   | 3.28.0-r0     | sqlite: use-after-free in      |\n|         |                  |          |                   |               | window function leading to     |\n|         |                  |          |                   |               | remote code execution          |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-11655   |          |                   | 3.28.0-r3     | sqlite: malformed              |\n|         |                  |          |                   |               | window-function query leads to |\n|         |                  |          |                   |               | DoS                            |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n")),Object(i.b)("h3",null,"Trivy Docker Run"),Object(i.b)("p",null,"Trivy can be run from Docker."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ docker run --rm -v [YOUR_CACHE_DIR]:/root/.cache/ aquasec/trivy [YOUR_IMAGE_NAME]\n\n$ docker run --rm -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy python:3.4-alpine\n")),Object(i.b)("h3",null,"Trivy Results as JSON"),Object(i.b)("p",null,"Trivy output can be generated as json."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ trivy image -f json -o results.json python:3.4-alpine\n")),Object(i.b)("h3",null,"Filter vulnerabilities by severities"),Object(i.b)("p",null,"Vulnerability results can be filtered. In the below example HIGH and CRITICAL issues are displayed"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ trivy image --severity HIGH,CRITICAL python:3.4-alpine\n")),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 4 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   |          | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    |          | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n")),Object(i.b)("h3",null,"Trivy Run - Exit Code"),Object(i.b)("p",null,"Exit code can be used to break the build based on condition. "),Object(i.b)("p",null,"This is useful while using Trivy in CICD"),Object(i.b)("h4",null,"Stop Build\v"),Object(i.b)("p",null,"Build stops, when CRITICAL and HIGH severities are found."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ trivy image --exit-code 1 --severity CRITICAL,HIGH python:3.4-alpine\n")),Object(i.b)("h4",null,"Continue Build\v"),Object(i.b)("p",null,"Build doesn’t stop, when MEDIUM and LOW found."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"$ trivy image --exit-code 0 --severity MEDIUM,LOW python:3.4-alpine\n")),Object(i.b)("h2",null,"Integrating Trivy with Jenkins and Tekton`"),Object(i.b)("p",null,"Lets integrate the Trivy in ",Object(i.b)("inlineCode",{parentName:"p"},"Jenkins")," and ",Object(i.b)("inlineCode",{parentName:"p"},"Tekton")," pipelines of Cloud Native Toolkit"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Create an App using ",Object(i.b)("a",l({parentName:"p"},{href:"/ibm-gsi-cloudnative-journey/developer-intermediate/deploy-app"}),"Deploy First App"),".")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Make changes to the ",Object(i.b)("inlineCode",{parentName:"p"},"Jenkins")," or ",Object(i.b)("inlineCode",{parentName:"p"},"Tekton")," pipelines as given below."))),Object(i.b)(p,{mdxType:"Tabs"},Object(i.b)(c,{label:"Jenkins",mdxType:"Tab"},Object(i.b)("p",null,"The CICD process contains several steps. There is a step called ",Object(i.b)("inlineCode",{parentName:"p"},"Build Image")," that will build a image and Push the image to the image registry.\n",Object(i.b)("span",l({parentName:"p"},{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}}),"\n      ",Object(i.b)("span",l({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"39.93055555555555%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEElEQVQoz51Q2XKDMAzM//9fT9I0DeUqmBRjY4yPrSXClD70oZXHo5UlrVc6VFWFsixB3loLshgjfrN97ide48OyLNiuNgpiEJxw3qGXgr1zDnVbQSrJzeJToE91ZPTWXlt47xFDItz/LkaBU/3ChGYxOFYZJjshhIBjmUHIleS9y5G3F8ad7LjHp49ZIQFtJpZsZgM5SsR0FrdgkAMXEqFMeFvJqEYorRhrrTkmsnXkNM6pvsLYmBR84Ll4YgI9azxc7qDSGmicx/we3dAyyVtzxrl5Zdz0NbLU4zaFIZCedaG0RzsnFbddE/G2+D0mT/Eeb/4QIyXWwqIrWJUPHv+xm8KA9ZJCi8lM+H77+/0CeuRw6uwv+YoAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(i.b)("img",l({parentName:"span"},{className:"gatsby-resp-image-image",alt:"Jenkins Pipeline",title:"Jenkins Pipeline",src:"/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/3cbba/01-jenkins-pipeline.png",srcSet:["/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/7fc1e/01-jenkins-pipeline.png 288w","/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/a5df1/01-jenkins-pipeline.png 576w","/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/3cbba/01-jenkins-pipeline.png 1152w","/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/0b124/01-jenkins-pipeline.png 1728w","/ibm-gsi-cloudnative-journey/static/1e4238bed0420d3a318118f9ca37d5ef/97581/01-jenkins-pipeline.png 1832w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    ")),Object(i.b)("p",null,"Need to split the step into 3 steps."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Build Image"),Object(i.b)("li",{parentName:"ul"},"Trivy Scan"),Object(i.b)("li",{parentName:"ul"},"Push Image")),Object(i.b)("p",null,"The modified pipeline should look like this.\n",Object(i.b)("span",l({parentName:"p"},{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}}),"\n      ",Object(i.b)("span",l({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"45.833333333333336%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABqklEQVQoz31S72sTQRC9P0KoKCi02Jqapg3VoqhQVBBbk7axFr+J+EEQ/+N8aWMTCMnt7e7d5fbX5Tk7RwqCdeHxdmZn3j1uJmk96aDd6eLu/Qf4cNzD5e9rDIdDjEYjjMfjBpMxptMphBC3Ik1TRrK9s4et7R0WPDkbQBQOQuaQMkOWCWIJrTWMqfC/U9c1vPdIHpPYZqvNgh/7p1Clgy4tpC6hCwMfagTCquE2xHdrLZL2bpcdrpFg73SAvDSYR/tCkdMSsggEz+JVZeCoyRpL7FhgxSEEOOeQvHl/jFeHb7G3f4Cv376jKApCjsouUC8DrKfiOrKjuOb4hsmVo3x898E1gv3BZ/TPPuH14Tv8+PkLlTFUXCPTAsZZ4gyWWOYZxQZCpTDWIJUp1VYcx4/LQiL4gCQ663Sf4uH6IwzOL1jQGIdUzbGoFsyxcS6JLQnoRmiWzfh9Jmc3g2GHWzSQjc0W7qzdw1HvhJPx+OD/McslizW35V+8mnSy/+w5Dl68ZNHziy+4vLqivZvQymS8LrnOG85zXqEJ7aSSiuOYb/55gbIsoZTCH/QKaZ2HRkCzAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(i.b)("img",l({parentName:"span"},{className:"gatsby-resp-image-image",alt:"Jenkins Pipeline with Trivy",title:"Jenkins Pipeline with Trivy",src:"/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/3cbba/02-jenkins-pipeline-with-trivy.png",srcSet:["/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/7fc1e/02-jenkins-pipeline-with-trivy.png 288w","/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/a5df1/02-jenkins-pipeline-with-trivy.png 576w","/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/3cbba/02-jenkins-pipeline-with-trivy.png 1152w","/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/0b124/02-jenkins-pipeline-with-trivy.png 1728w","/ibm-gsi-cloudnative-journey/static/e289ea197ce44d16fcea26788bfe0554/a7ba4/02-jenkins-pipeline-with-trivy.png 2236w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    ")),Object(i.b)("h4",null,"Build Image"),Object(i.b)("p",null,"The build image will build the image."),Object(i.b)("h4",null,"Trivy Scan"),Object(i.b)("p",null,"Trivy scan will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue."),Object(i.b)("h4",null,"Push Image"),Object(i.b)("p",null,"After the scan is completed, it Pushes the image to the Image Registry."),Object(i.b)(s,{mdxType:"BR"}),Object(i.b)(s,{mdxType:"BR"}),Object(i.b)("p",null,"The pipeline scripts are defined in the ",Object(i.b)("inlineCode",{parentName:"p"},"jenkinsfile"),". lets us see the changes done in the jenkins file."),Object(i.b)("h2",null,"Jenkinsfile Changes"),Object(i.b)("h3",null,"Declaration"),Object(i.b)("p",null,"The below code snippet is the declaration about Trivy image, to be added in the ",Object(i.b)("inlineCode",{parentName:"p"},"containers")," section under ",Object(i.b)("inlineCode",{parentName:"p"},"podTemplate")," in the ",Object(i.b)("inlineCode",{parentName:"p"},"jenkinsfile")),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'```\n- name: trivy\n    image: docker.io/aquasec/trivy\n    tty: true\n    command: ["/bin/sh"]\n    workingDir: ${workingDir}\n    securityContext:\n    privileged: true\n    envFrom:\n    - configMapRef:\n        name: ibmcloud-config\n    - secretRef:\n        name: ibmcloud-apikey       \n```\n')),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"name"),"  -  ",Object(i.b)("inlineCode",{parentName:"li"},"trivy")," will be used in the script to refer the trivy container."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"image")," - image tag of the ",Object(i.b)("inlineCode",{parentName:"li"},"trivy"),"."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"configMapRef")," -  A configmap contains ",Object(i.b)("inlineCode",{parentName:"li"},"username")," details to connect to IBM Cloud Container registry."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"secretRef")," A secrte contains ",Object(i.b)("inlineCode",{parentName:"li"},"password")," to connect to IBM Cloud Container registry.")),Object(i.b)("h3",null,"Build Image"),Object(i.b)("p",null,"Here are the steps to Build Image. Replace the existing content under the ",Object(i.b)("inlineCode",{parentName:"p"},"container(name: 'buildah'")),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'container(name: \'buildah\', shell: \'/bin/bash\') {\n    stage(\'Build image\') {\n        sh \'\'\'#!/bin/bash\n            set -e\n            . ./env-config\n\n            echo TLSVERIFY=${TLSVERIFY}\n            echo CONTEXT=${CONTEXT}\n        IMAGE_VERSION="0.0.1"\n\n            if [[ -z "${REGISTRY_PASSWORD}" ]]; then\n                REGISTRY_PASSWORD="${APIKEY}"\n            fi\n\n        APP_IMAGE="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n\n        echo "Image... $APP_IMAGE"\n\n        buildah bud --tls-verify=${TLSVERIFY} --format=docker -f ${DOCKERFILE} -t ${APP_IMAGE} ${CONTEXT}\n\n        if [[ -n "${REGISTRY_USER}" ]] && [[ -n "${REGISTRY_PASSWORD}" ]]; then\n            buildah login -u "${REGISTRY_USER}" -p "${REGISTRY_PASSWORD}" "${REGISTRY_URL}"\n        fi\n\n        buildah push --tls-verify=${TLSVERIFY} "${APP_IMAGE}" "docker://${APP_IMAGE}"\n        \'\'\'\n    }\n}\n')),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The variable ",Object(i.b)("inlineCode",{parentName:"p"},"APP_IMAGE=")," contains the Temp image name. ")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Image is build using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah")," and tagged with temp image name.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Login into IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Temp image is pushed to IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),"."))),Object(i.b)("h3",null,"Trivy Scan"),Object(i.b)("p",null,"The below code snippet is for trivy Scanning. Add the below code under the previous step `Build Image’"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'        container(name: \'trivy\', shell: \'/bin/sh\') {\n            stage(\'Trivy Scan\') {\n\n                  sh \'\'\'#!/bin/sh\n\n                    set -e\n                    . ./env-config\n\n                    echo TLSVERIFY=${TLSVERIFY}\n                    echo CONTEXT=${CONTEXT}\n                    IMAGE_VERSION="0.0.1"\n\n                    if [[ -z "${REGISTRY_PASSWORD}" ]]; then\n                      REGISTRY_PASSWORD="${APIKEY}"\n                    fi\n\n                    APP_IMAGE_Temp="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n\n                    export TRIVY_AUTH_URL=${REGISTRY_URL}\n                    export TRIVY_USERNAME=${REGISTRY_USER}\n                    export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n\n                    echo "Trivy image scanning started.... $APP_IMAGE_Temp"\n\n                    # Trivy scan\n                    trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}\n                    #trivy image ${APP_IMAGE_Temp}\n\n                    # Check scan results\n                    my_exit_code=$?\n                    echo "scan exit code : $my_exit_code"\n                    if [ ${my_exit_code} == 1 ]; then\n                        echo "Image scanning failed. Some vulnerabilities found"\n                        exit 1;\n                    else\n                        echo "Image is scanned Successfully. No vulnerabilities found"\n                    fi;\n                \'\'\'\n            }\n        }\n\n')),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The temporary image is scanned here.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_AUTH_URL,")," ",Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_USERNAME"),", ",Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_PASSWORD")," refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}")," - step scans the temp image available in the IBM Cloud Container Registry.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The step stops and then the pipeline also stops when there is a CRITICAL issue found.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"If you don’t want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with ",Object(i.b)("inlineCode",{parentName:"p"},"trivy ${APP_IMAGE_Temp}"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The scan results will be printed in the console."))),Object(i.b)("h3",null,"Push Image"),Object(i.b)("p",null,"The below code snippet is for Pushing Image. Add the below code under the previous step `Trivy Scan’"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'        container(name: \'buildah\', shell: \'/bin/bash\') {\n            stage(\'Push image\') {\n                sh \'\'\'#!/bin/bash\n                    set -e\n                    . ./env-config\n\n                    echo TLSVERIFY=${TLSVERIFY}\n                    echo CONTEXT=${CONTEXT}\n                IMAGE_VERSION="0.0.1"\n\n                    if [[ -z "${REGISTRY_PASSWORD}" ]]; then\n                      REGISTRY_PASSWORD="${APIKEY}"\n                    fi\n\n                APP_IMAGE="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}"\n                APP_IMAGE_Temp="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n\n                if [[ -n "${REGISTRY_USER}" ]] && [[ -n "${REGISTRY_PASSWORD}" ]]; then\n                    buildah login -u "${REGISTRY_USER}" -p "${REGISTRY_PASSWORD}" "${REGISTRY_URL}"\n                fi\n        \n                buildah pull ${APP_IMAGE_Temp}\n                buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n                buildah push --tls-verify=${TLSVERIFY} "${APP_IMAGE}" "docker://${APP_IMAGE}"\n                buildah rmi ${APP_IMAGE_Temp}\n                \'\'\'\n            }\n        }\n')),Object(i.b)("p",null,"The code snippet does the followings."),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Login into IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Pull the temp image using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Tag the image to the actual image name.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Push the actual image to IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Remove the temp image from IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")))),Object(i.b)(c,{label:"Tekton",mdxType:"Tab"},Object(i.b)("p",null,"The CICD process contains several steps. There is a step called ",Object(i.b)("inlineCode",{parentName:"p"},"Build")," that will build a image and Push the image to the image registry."),Object(i.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(i.b)("span",l({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"39.583333333333336%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGElEQVQoz51RS26DMBT0ERCHohdt1uzYsekBuiBdZpUWQkPBYPAHYzL1c5sqidRG6kijZ48fwxubGWMhpYS1M06n0/8IwLXvmF93YBWvUR5KVGUVDm9x33ANfdPuBePzE1g7anChoJTENElobfzECsYYryms63rf1PeQLY3D+mHEsfmAEALL4uCc83X5qWT4F8+R8W3MxlGgaRpwztH3PbquwzAMoXJOex7Wt6T+tm19In11NYwmI2RZhiR58EyQ5/nXvUxTiE0fkYGUU1hrpYJOpBRXhoe6DsLmcYMoihDHMdI0DRrFPqPpGgipYb3kVvwKdjjWUGYJExRFge12G6Jf/pWwr/Z4O3YQaoWeXXiCy4ehSa21+AS9gWOQ1bDFIwAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(i.b)("img",l({parentName:"span"},{className:"gatsby-resp-image-image",alt:"Tekton Pipeline",title:"Tekton Pipeline",src:"/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/3cbba/05-tekton-pipeline.png",srcSet:["/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/7fc1e/05-tekton-pipeline.png 288w","/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/a5df1/05-tekton-pipeline.png 576w","/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/3cbba/05-tekton-pipeline.png 1152w","/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/0b124/05-tekton-pipeline.png 1728w","/ibm-gsi-cloudnative-journey/static/9ee83d15be3d61f6b3de0a3a33821443/f5222/05-tekton-pipeline.png 1968w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "),Object(i.b)("p",null,"Need to split the step into 3 steps."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"image-build"),Object(i.b)("li",{parentName:"ul"},"image-scan-trivy"),Object(i.b)("li",{parentName:"ul"},"image-push")),Object(i.b)("p",null,"The modified pipeline should look like this.\n",Object(i.b)("span",l({parentName:"p"},{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}}),"\n      ",Object(i.b)("span",l({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"39.583333333333336%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVQoz51Ry26DMBD0Fb6KY/hK7tyjnMKhH9BTjzmlhaShGDD4EcdmyrolaiK1kTrSyKvZ9WgfzBgLKSWsPWOapv8RgGvecX7dgVXtEeWhRFVWIXmPx4Y+1I27FwzPT2DNoNEKBaUkxlFCazN3rGCMmTUF7/1j07mGbKkd1vUDTvUHhBC4XBycc/N7ub5k+BeXkfFtzIZBoK5rtG2LruvQNA36vgfnPGictyG+J+WoVmt9sxpGnRE2mw3SNMVqtUJRFF97GccwNn0iAynHEGulgk6kKW4MD8dDELIsQxRFiOMYeZ4HjcZeUPMaQmrYWXIev4KVxyoE6/UaSZIEbrfbq+Fy+X21x9uJQygPfXbhBD8PQ51aa/EJbhBepPNHlVoAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(i.b)("img",l({parentName:"span"},{className:"gatsby-resp-image-image",alt:"Tekton Pipeline with Trivy",title:"Tekton Pipeline with Trivy",src:"/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/3cbba/06-tekton-pipeline-with-trivy.png",srcSet:["/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/7fc1e/06-tekton-pipeline-with-trivy.png 288w","/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/a5df1/06-tekton-pipeline-with-trivy.png 576w","/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/3cbba/06-tekton-pipeline-with-trivy.png 1152w","/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/0b124/06-tekton-pipeline-with-trivy.png 1728w","/ibm-gsi-cloudnative-journey/static/47eb90c2bf7c9203583db038de9717c8/f5222/06-tekton-pipeline-with-trivy.png 1968w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    ")),Object(i.b)("h4",null,"image-build"),Object(i.b)("p",null,"This step will build the image."),Object(i.b)("h4",null,"image-scan-trivy"),Object(i.b)("p",null,"This step will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue."),Object(i.b)("h4",null,"image-push"),Object(i.b)("p",null,"After the scan is completed, this step Pushes the image to the Image Registry."),Object(i.b)("p",null,"The pipeline scripts are defined as Task in the yaml file. lets us see the changes done in the task file."),Object(i.b)("h2",null,"Tekton Task Changes"),Object(i.b)("h3",null,"Extract the existing tekton task yaml"),Object(i.b)("p",null,"1.Run the below command"),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"oc get tasks    \n")),Object(i.b)("p",null,"you may get the output like this. The relvant task related to the build and push would be ",Object(i.b)("inlineCode",{parentName:"p"},"igc-build-tag-push-v1-23-0"),"."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"NAME                               AGE\nigc-build-tag-push-v1-23-0         52m\nigc-deploy-v1-23-0                 52m\nigc-gitops-v1-23-0                 52m\nigc-goland-test                    52m\nigc-gradle-pact-verify-v1-23-0     52m\nigc-health-check-v1-23-0           52m\nigc-helm-package-v1-23-0           52m\nigc-java-gradle-test-v1-23-0       52m\nigc-java-maven-test-v1-23-0        52m\nigc-liberty-server-check-v1-23-0   52m\nigc-nodejs-test-v1-23-0            52m\n")),Object(i.b)("p",null,"2.Run the below command to extract the task content into "),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"oc get tasks igc-build-tag-push-v1-23-0 -o yaml > igc-build-tag-push-v1-23-0.yaml\n")),Object(i.b)("p",null,"3.Update the ",Object(i.b)("inlineCode",{parentName:"p"},"igc-build-tag-push-v1-23-0.yaml")," file as per the given below steps."),Object(i.b)("h3",null,"Declaration"),Object(i.b)("p",null,"Add the below code code snippet as declaration about the Trivy image in the ",Object(i.b)("inlineCode",{parentName:"p"},"Task")),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"    - default: docker.io/aquasec/trivy\n      name: trivy\n      type: string     \n")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"After adding the Task code should be like this."),Object(i.b)("li",{parentName:"ul"},"Replace the namespace ",Object(i.b)("inlineCode",{parentName:"li"},"trivy-demo"),", with your project namespace.")),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"apiVersion: tekton.dev/v1alpha1\nkind: Task\nmetadata:\n  name: igc-build-tag-push-v1-23-0\n  namespace: trivy-demo\n  labels:\n    version: 1.23.0\nspec:\n  inputs:\n    params:\n      - default: 'docker.io/node:12-stretch'\n        name: js-image\n        type: string\n      - default: 'quay.io/buildah/stable:v1.11.0'\n        name: BUILDER_IMAGE\n        type: string\n      - default: ./Dockerfile\n        name: DOCKERFILE\n        type: string\n      - default: docker.io/aquasec/trivy\n        name: trivy\n        type: string      \n      - default: .\n        name: CONTEXT\n        type: string\n      - default: 'false'\n        name: TLSVERIFY\n        type: string\n    resources:\n      - name: source\n        type: git\n  outputs:\n    resources:\n      - name: image\n        type: image\n")),Object(i.b)("h3",null,"Image Build"),Object(i.b)("p",null,"Replace the content of the step ‘build’ with the below code snippet."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'    - resources: {}\n      name: image-build\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - \'-c\'\n        - >\n          set -e\n\n          . ./env-config\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / \'{print $1}\')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / \'{print $2}\')\n\n\n          APP_IMAGE="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n\n\n          buildah bud --tls-verify=$(inputs.params.TLSVERIFY) --format=docker -f $(inputs.params.DOCKERFILE) -t ${APP_IMAGE}  $(inputs.params.CONTEXT)\n\n          if [[ -n "${REGISTRY_USER}" ]] && [[ -n "${REGISTRY_PASSWORD}" ]];\n          then\n            buildah login -u "${REGISTRY_USER}" -p "${REGISTRY_PASSWORD}" "${REGISTRY_URL}"\n          fi\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) "${APP_IMAGE}" "docker://${APP_IMAGE}"\n\n')),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Temp image is build using ",Object(i.b)("inlineCode",{parentName:"li"},"buildah")),Object(i.b)("li",{parentName:"ol"},"Login into IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"li"},"buildah"),"."),Object(i.b)("li",{parentName:"ol"},"Temp image is pushed to IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"li"},"buildah"),"."),Object(i.b)("li",{parentName:"ol"},"env ",Object(i.b)("inlineCode",{parentName:"li"},"REGISTRY_USER")," contains Username details to Login into IBM Cloud Container Registry."),Object(i.b)("li",{parentName:"ol"},"env ",Object(i.b)("inlineCode",{parentName:"li"},"REGISTRY_PASSWORD")," contains Password details to Login into IBM Cloud Container Registry."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"name: build")," refers the name of the step")),Object(i.b)("h3",null,"Image Scan Trivy"),Object(i.b)("p",null,"Add the below code code snippet in the ",Object(i.b)("inlineCode",{parentName:"p"},"Task")," for trivy scanning."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'    - resources: {}\n      name: image-scan-trivy\n      command:\n      - /bin/sh\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.trivy)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - \'-c\'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / \'{print $1}\')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / \'{print $2}\')\n\n\n          APP_IMAGE="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n\n          export TRIVY_AUTH_URL=${REGISTRY_URL}\n\n          export TRIVY_USERNAME=${REGISTRY_USER}\n\n          export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n    \n          echo "Trivy image scanning...111. $APP_IMAGE"\n    \n          # Trivy scan\n\n          trivy image ${APP_IMAGE}\n\n          #trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE}\n\n          echo "Trivy image scanning...222. $APP_IMAGE"\n\n          # Trivy scan result processing\n          \n          my_exit_code=$?\n\n          echo "RESULT 1:--- $my_exit_code"\n    \n          if [ ${my_exit_code} == 1 ]; then\n\n              echo "Image scanning failed. Some vulnerabilities found"\n\n              exit 1;\n          else\n              echo "Image is scanned Successfully. No vulnerabilities found"\n\n          fi;\n')),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The temporary image is scanned here.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_AUTH_URL,")," ",Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_USERNAME"),", ",Object(i.b)("inlineCode",{parentName:"p"},"TRIVY_PASSWORD")," refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},Object(i.b)("inlineCode",{parentName:"p"},"trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}")," - step scans the temp image available in the IBM Cloud Container Registry.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The step stops and then the pipeline also stops when there is a CRITICAL issue found.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"If you don’t want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with ",Object(i.b)("inlineCode",{parentName:"p"},"trivy ${APP_IMAGE_Temp}"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"The scan results will be printed in the console."))),Object(i.b)("h3",null,"Image Push"),Object(i.b)("p",null,"Add the below code code snippet in the ",Object(i.b)("inlineCode",{parentName:"p"},"Task")," for pushing image."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),'     - resources: {}\n      name: image-push\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - \'-c\'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / \'{print $1}\')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / \'{print $2}\')\n\n          APP_IMAGE="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}"\n\n          APP_IMAGE_Temp="${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}"\n    \n          if [[ -n "${REGISTRY_USER}" ]] && [[ -n "${REGISTRY_PASSWORD}" ]]; then\n              buildah login -u "${REGISTRY_USER}" -p "${REGISTRY_PASSWORD}" "${REGISTRY_URL}"\n          fi\n    \n          buildah pull ${APP_IMAGE_Temp}\n\n          buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) "${APP_IMAGE}"  "docker://${APP_IMAGE}"\n\n          buildah rmi ${APP_IMAGE_Temp}\n')),Object(i.b)("p",null,"The code snippet does the followings."),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Login into IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Pull the temp image using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Tag the image to the actual image name.")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Push the actual image to IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Remove the temp image from IBM Cloud Container Registry using ",Object(i.b)("inlineCode",{parentName:"p"},"buildah"),"."))),Object(i.b)("h3",null,"Push the pipeline changes"),Object(i.b)("p",null,"Run the below command to apply the pipeline changes back to the cluster."),Object(i.b)("pre",null,Object(i.b)("code",l({parentName:"pre"},{}),"oc apply -f igc-build-tag-push-v1-23-0.yaml\n")))))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-developer-advanced-devsecops-trivy-index-mdx-7c2984972c7f63be59a6.js.map