{"componentChunkName":"component---src-pages-developer-advanced-devsecops-trivy-index-mdx","path":"/developer-advanced/devsecops-trivy/","result":{"pageContext":{"frontmatter":{"title":"DevSecOps with Trivy"},"relativePagePath":"/developer-advanced/devsecops-trivy/index.mdx","titleType":"page","MdxNode":{"id":"562e731d-dfb2-5b6a-917f-e091171e0536","children":[],"parent":"d1e455ec-35fb-5af8-bef6-307c0babd288","internal":{"content":"---\ntitle: DevSecOps with Trivy\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nIntegrating Aquasec Trivy in in CICD Pipeline for DevSecOps\n\n</PageDescription>\n\n## Overview\n\nDevSecOps ensures the security by doing Vulnerability scanning on the container images. There are several tools available for image scanning. \n\n`Trivy` is a Simple and Comprehensive Vulnerability Scanner for Containers, Suitable for CI.\n\nThe more information on Trivy is available in https://github.com/aquasecurity/trivy\n\n## Working with Trivy Commands\n\n### Installation \nTrivy installation is very simple. You can use homebrew on macOS to install\n```\n$ brew install aquasecurity/trivy/trivy\n```\n\n### Trivy Standalone Run\nTrivy can be run as standalone in Desktop or in laptop .\n```\n$ trivy image [YOUR_IMAGE_NAME]\n\n\n$ trivy image python:3.4-alpine\n```\n\nOutput\n```\n2020-06-23T23:11:07.297+0530\tINFO\tDetecting Alpine vulnerabilities...\n\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 15 (UNKNOWN: 0, LOW: 1, MEDIUM: 10, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-15903   | MEDIUM   |                   | 2.2.7-r1      | expat: heap-based buffer       |\n|         |                  |          |                   |               | over-read via crafted XML      |\n|         |                  |          |                   |               | input                          |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   | HIGH     | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| openssl | CVE-2019-1543    | MEDIUM   | 1.1.1a-r1         | 1.1.1b-r1     | openssl: ChaCha20-Poly1305     |\n|         |                  |          |                   |               | with long nonces               |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1549    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in fork()           |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1551    |          |                   | 1.1.1d-r2     | openssl: Integer overflow in   |\n|         |                  |          |                   |               | RSAZ modular exponentiation on |\n|         |                  |          |                   |               | x86_64                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1563    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in PKCS7_dataDecode |\n|         |                  |          |                   |               | and CMS_decrypt_set1_pkey      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-1967    |          |                   | 1.1.1g-r0     | openssl: Segmentation fault in |\n|         |                  |          |                   |               | SSL_check_chain causes denial  |\n|         |                  |          |                   |               | of service                     |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-1547    | LOW      |                   | 1.1.1d-r0     | openssl: side-channel weak     |\n|         |                  |          |                   |               | encryption vulnerability       |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    | HIGH     | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-16168   | MEDIUM   |                   | 3.28.0-r1     | sqlite: division by zero in    |\n|         |                  |          |                   |               | whereLoopAddBtreeIndex in      |\n|         |                  |          |                   |               | sqlite3.c                      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-19242   |          |                   | 3.28.0-r2     | sqlite: SQL injection in       |\n|         |                  |          |                   |               | sqlite3ExprCodeTarget in       |\n|         |                  |          |                   |               | expr.c                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-5018    |          |                   | 3.28.0-r0     | sqlite: use-after-free in      |\n|         |                  |          |                   |               | window function leading to     |\n|         |                  |          |                   |               | remote code execution          |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-11655   |          |                   | 3.28.0-r3     | sqlite: malformed              |\n|         |                  |          |                   |               | window-function query leads to |\n|         |                  |          |                   |               | DoS                            |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n```\n\n### Trivy Docker Run\n\nTrivy can be run from Docker.\n\n```\n$ docker run --rm -v [YOUR_CACHE_DIR]:/root/.cache/ aquasec/trivy [YOUR_IMAGE_NAME]\n\n$ docker run --rm -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy python:3.4-alpine\n```\n\n### Trivy Results as JSON\n\nTrivy output can be generated as json.\n\n```\n$ trivy image -f json -o results.json python:3.4-alpine\n```\n\n### Filter vulnerabilities by severities\n\nVulnerability results can be filtered. In the below example HIGH and CRITICAL issues are displayed\n\n```\n$ trivy image --severity HIGH,CRITICAL python:3.4-alpine\n```\n\n```\n\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 4 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   |          | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    |          | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n```\n\n### Trivy Run - Exit Code\n\nExit code can be used to break the build based on condition. \n\nThis is useful while using Trivy in CICD\n\n\n#### Stop Build\u000b\n\nBuild stops, when CRITICAL and HIGH severities are found.\n\n```\n$ trivy image --exit-code 1 --severity CRITICAL,HIGH python:3.4-alpine\n```\n\n\n#### Continue Build\u000b\n\nBuild doesn't stop, when MEDIUM and LOW found.\n\n```\n$ trivy image --exit-code 0 --severity MEDIUM,LOW python:3.4-alpine\n```\n\n\n## Integrating Trivy with Jenkins and Tekton`\n\nLets integrate the Trivy in `Jenkins` and `Tekton` pipelines of Cloud Native Toolkit\n\n- Create an App using [Deploy First App](/developer-intermediate/deploy-app).\n\n- Make changes to the `Jenkins` or `Tekton` pipelines as given below.\n\n<Tabs>\n<Tab label=\"Jenkins\">\n\nThe CICD process contains several steps. There is a step called `Build Image` that will build a image and Push the image to the image registry.\n![Jenkins Pipeline](/images/01-jenkins-pipeline.png)\n\nNeed to split the step into 3 steps.\n- Build Image\n- Trivy Scan\n- Push Image\n\nThe modified pipeline should look like this.\n![Jenkins Pipeline with Trivy](/images/02-jenkins-pipeline-with-trivy.png)\n\n#### Build Image\nThe build image will build the image.\n\n#### Trivy Scan\nTrivy scan will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue.\n\n#### Push Image\nAfter the scan is completed, it Pushes the image to the Image Registry.\n\n<BR></BR>\n<BR></BR>\n\nThe pipeline scripts are defined in the `jenkinsfile`. lets us see the changes done in the jenkins file.\n\n## Jenkinsfile Changes\n\n### Declaration\n\nThe below code snippet is the declaration about Trivy image, to be added in the `containers` section under `podTemplate` in the `jenkinsfile`\n\n    ```\n    - name: trivy\n        image: docker.io/aquasec/trivy\n        tty: true\n        command: [\"/bin/sh\"]\n        workingDir: ${workingDir}\n        securityContext:\n        privileged: true\n        envFrom:\n        - configMapRef:\n            name: ibmcloud-config\n        - secretRef:\n            name: ibmcloud-apikey       \n    ```\n\n1. `name`  -  `trivy` will be used in the script to refer the trivy container.\n2. `image` - image tag of the `trivy`.\n3. `configMapRef` -  A configmap contains `username` details to connect to IBM Cloud Container registry.\n4. `secretRef` A secrte contains `password` to connect to IBM Cloud Container registry.\n\n### Build Image\n\nHere are the steps to Build Image. Replace the existing content under the `container(name: 'buildah'`\n\n```\ncontainer(name: 'buildah', shell: '/bin/bash') {\n    stage('Build image') {\n        sh '''#!/bin/bash\n            set -e\n            . ./env-config\n\n            echo TLSVERIFY=${TLSVERIFY}\n            echo CONTEXT=${CONTEXT}\n        IMAGE_VERSION=\"0.0.1\"\n\n            if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n                REGISTRY_PASSWORD=\"${APIKEY}\"\n            fi\n\n        APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n        echo \"Image... $APP_IMAGE\"\n\n        buildah bud --tls-verify=${TLSVERIFY} --format=docker -f ${DOCKERFILE} -t ${APP_IMAGE} ${CONTEXT}\n\n        if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n            buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n        fi\n\n        buildah push --tls-verify=${TLSVERIFY} \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n        '''\n    }\n}\n```\n\n1. The variable `APP_IMAGE=` contains the Temp image name. \n\n2. Image is build using `buildah` and tagged with temp image name.\n\n3. Login into IBM Cloud Container Registry using `buildah`.\n\n4. Temp image is pushed to IBM Cloud Container Registry using `buildah`.\n\n\n### Trivy Scan\n\nThe below code snippet is for trivy Scanning. Add the below code under the previous step `Build Image'\n\n```\n        container(name: 'trivy', shell: '/bin/sh') {\n            stage('Trivy Scan') {\n\n                  sh '''#!/bin/sh\n\n                    set -e\n                    . ./env-config\n\n                    echo TLSVERIFY=${TLSVERIFY}\n                    echo CONTEXT=${CONTEXT}\n                    IMAGE_VERSION=\"0.0.1\"\n\n                    if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n                      REGISTRY_PASSWORD=\"${APIKEY}\"\n                    fi\n\n                    APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n                    export TRIVY_AUTH_URL=${REGISTRY_URL}\n                    export TRIVY_USERNAME=${REGISTRY_USER}\n                    export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n\n                    echo \"Trivy image scanning started.... $APP_IMAGE_Temp\"\n\n                    # Trivy scan\n                    trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}\n                    #trivy image ${APP_IMAGE_Temp}\n\n                    # Check scan results\n                    my_exit_code=$?\n                    echo \"scan exit code : $my_exit_code\"\n                    if [ ${my_exit_code} == 1 ]; then\n                        echo \"Image scanning failed. Some vulnerabilities found\"\n                        exit 1;\n                    else\n                        echo \"Image is scanned Successfully. No vulnerabilities found\"\n                    fi;\n                '''\n            }\n        }\n\n```\n\n1. The temporary image is scanned here.\n\n2. `TRIVY_AUTH_URL,` `TRIVY_USERNAME`, `TRIVY_PASSWORD` refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.\n\n3. `trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}` - step scans the temp image available in the IBM Cloud Container Registry.\n\n4. The step stops and then the pipeline also stops when there is a CRITICAL issue found.\n\n5. If you don't want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with `trivy ${APP_IMAGE_Temp}`.\n\n6. The scan results will be printed in the console.\n\n\n### Push Image\n\nThe below code snippet is for Pushing Image. Add the below code under the previous step `Trivy Scan'\n\n```\n        container(name: 'buildah', shell: '/bin/bash') {\n            stage('Push image') {\n                sh '''#!/bin/bash\n                    set -e\n                    . ./env-config\n\n\t\t            echo TLSVERIFY=${TLSVERIFY}\n\t\t            echo CONTEXT=${CONTEXT}\n                IMAGE_VERSION=\"0.0.1\"\n\n\t\t            if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n\t\t              REGISTRY_PASSWORD=\"${APIKEY}\"\n\t\t            fi\n\n                APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}\"\n                APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n                if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n                    buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n                fi\n        \n                buildah pull ${APP_IMAGE_Temp}\n                buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n                buildah push --tls-verify=${TLSVERIFY} \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n                buildah rmi ${APP_IMAGE_Temp}\n                '''\n            }\n        }\n```\n\nThe code snippet does the followings.\n\n1. Login into IBM Cloud Container Registry using `buildah`.\n\n2. Pull the temp image using `buildah`.\n\n3. Tag the image to the actual image name.\n\n4. Push the actual image to IBM Cloud Container Registry using `buildah`.\n\n5. Remove the temp image from IBM Cloud Container Registry using `buildah`.\n\n</Tab>\n\n<Tab label=\"Tekton\">\n\nThe CICD process contains several steps. There is a step called `Build` that will build a image and Push the image to the image registry.\n\n![Tekton Pipeline](/images/05-tekton-pipeline.png)\n\nNeed to split the step into 3 steps.\n- image-build\n- image-scan-trivy\n- image-push\n\nThe modified pipeline should look like this.\n![Tekton Pipeline with Trivy](/images/06-tekton-pipeline-with-trivy.png)\n\n#### image-build\nThis step will build the image.\n\n#### image-scan-trivy\nThis step will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue.\n\n#### image-push\nAfter the scan is completed, this step Pushes the image to the Image Registry.\n\n\nThe pipeline scripts are defined as Task in the yaml file. lets us see the changes done in the task file.\n\n## Tekton Task Changes\n\n\n### Extract the existing tekton task yaml\n\n1.Run the below command\n\n```\noc get tasks    \n```\n\nyou may get the output like this. The relvant task related to the build and push would be `igc-build-tag-push-v1-23-0`.\n\n\n```\nNAME                               AGE\nigc-build-tag-push-v1-23-0         52m\nigc-deploy-v1-23-0                 52m\nigc-gitops-v1-23-0                 52m\nigc-goland-test                    52m\nigc-gradle-pact-verify-v1-23-0     52m\nigc-health-check-v1-23-0           52m\nigc-helm-package-v1-23-0           52m\nigc-java-gradle-test-v1-23-0       52m\nigc-java-maven-test-v1-23-0        52m\nigc-liberty-server-check-v1-23-0   52m\nigc-nodejs-test-v1-23-0            52m\n```\n\n2.Run the below command to extract the task content into \n\n```\noc get tasks igc-build-tag-push-v1-23-0 -o yaml > igc-build-tag-push-v1-23-0.yaml\n```\n\n3.Update the `igc-build-tag-push-v1-23-0.yaml` file as per the given below steps.\n\n### Declaration\n\nAdd the below code code snippet as declaration about the Trivy image in the `Task`\n\n```\n    - default: docker.io/aquasec/trivy\n      name: trivy\n      type: string     \n```\n\n- After adding the Task code should be like this.\n- Replace the namespace `trivy-demo`, with your project namespace.\n\n```\napiVersion: tekton.dev/v1alpha1\nkind: Task\nmetadata:\n  name: igc-build-tag-push-v1-23-0\n  namespace: trivy-demo\n  labels:\n    version: 1.23.0\nspec:\n  inputs:\n    params:\n      - default: 'docker.io/node:12-stretch'\n        name: js-image\n        type: string\n      - default: 'quay.io/buildah/stable:v1.11.0'\n        name: BUILDER_IMAGE\n        type: string\n      - default: ./Dockerfile\n        name: DOCKERFILE\n        type: string\n      - default: docker.io/aquasec/trivy\n        name: trivy\n        type: string      \n      - default: .\n        name: CONTEXT\n        type: string\n      - default: 'false'\n        name: TLSVERIFY\n        type: string\n    resources:\n      - name: source\n        type: git\n  outputs:\n    resources:\n      - name: image\n        type: image\n```\n\n### Image Build\n\nReplace the content of the step 'build' with the below code snippet.\n\n```\n    - resources: {}\n      name: image-build\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n          . ./env-config\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n\n          buildah bud --tls-verify=$(inputs.params.TLSVERIFY) --format=docker -f $(inputs.params.DOCKERFILE) -t ${APP_IMAGE}  $(inputs.params.CONTEXT)\n\n          if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]];\n          then\n            buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n          fi\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n\n```\n\n1. Temp image is build using `buildah`\n2. Login into IBM Cloud Container Registry using `buildah`.\n3. Temp image is pushed to IBM Cloud Container Registry using `buildah`.\n4. env `REGISTRY_USER` contains Username details to Login into IBM Cloud Container Registry.\n5. env `REGISTRY_PASSWORD` contains Password details to Login into IBM Cloud Container Registry.\n6. `name: build` refers the name of the step\n\n### Image Scan Trivy\n\nAdd the below code code snippet in the `Task` for trivy scanning.\n\n```\n    - resources: {}\n      name: image-scan-trivy\n      command:\n      - /bin/sh\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.trivy)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n          export TRIVY_AUTH_URL=${REGISTRY_URL}\n\n          export TRIVY_USERNAME=${REGISTRY_USER}\n\n          export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n    \n          echo \"Trivy image scanning...111. $APP_IMAGE\"\n    \n          # Trivy scan\n\n          trivy image ${APP_IMAGE}\n\n          #trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE}\n\n          echo \"Trivy image scanning...222. $APP_IMAGE\"\n\n          # Trivy scan result processing\n          \n          my_exit_code=$?\n\n          echo \"RESULT 1:--- $my_exit_code\"\n    \n          if [ ${my_exit_code} == 1 ]; then\n\n              echo \"Image scanning failed. Some vulnerabilities found\"\n\n              exit 1;\n          else\n              echo \"Image is scanned Successfully. No vulnerabilities found\"\n\n          fi;\n```\n\n1. The temporary image is scanned here.\n\n2. `TRIVY_AUTH_URL,` `TRIVY_USERNAME`, `TRIVY_PASSWORD` refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.\n\n3. `trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}` - step scans the temp image available in the IBM Cloud Container Registry.\n\n4. The step stops and then the pipeline also stops when there is a CRITICAL issue found.\n\n5. If you don't want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with `trivy ${APP_IMAGE_Temp}`.\n\n6. The scan results will be printed in the console.\n\n\n### Image Push\n\nAdd the below code code snippet in the `Task` for pushing image.\n\n```\n     - resources: {}\n      name: image-push\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}\"\n\n          APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n    \n          if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n              buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n          fi\n    \n          buildah pull ${APP_IMAGE_Temp}\n\n          buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) \"${APP_IMAGE}\"  \"docker://${APP_IMAGE}\"\n\n          buildah rmi ${APP_IMAGE_Temp}\n```\n\nThe code snippet does the followings.\n\n1. Login into IBM Cloud Container Registry using `buildah`.\n\n2. Pull the temp image using `buildah`.\n\n3. Tag the image to the actual image name.\n\n4. Push the actual image to IBM Cloud Container Registry using `buildah`.\n\n5. Remove the temp image from IBM Cloud Container Registry using `buildah`.\n\n\n### Push the pipeline changes\n\nRun the below command to apply the pipeline changes back to the cluster.\n```\noc apply -f igc-build-tag-push-v1-23-0.yaml\n```\n\n\n</Tab>\n\n</Tabs>\n","type":"Mdx","contentDigest":"5737437e47519c3335f0b0b73f01cfa2","counter":824,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"DevSecOps with Trivy"},"exports":{},"rawBody":"---\ntitle: DevSecOps with Trivy\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nIntegrating Aquasec Trivy in in CICD Pipeline for DevSecOps\n\n</PageDescription>\n\n## Overview\n\nDevSecOps ensures the security by doing Vulnerability scanning on the container images. There are several tools available for image scanning. \n\n`Trivy` is a Simple and Comprehensive Vulnerability Scanner for Containers, Suitable for CI.\n\nThe more information on Trivy is available in https://github.com/aquasecurity/trivy\n\n## Working with Trivy Commands\n\n### Installation \nTrivy installation is very simple. You can use homebrew on macOS to install\n```\n$ brew install aquasecurity/trivy/trivy\n```\n\n### Trivy Standalone Run\nTrivy can be run as standalone in Desktop or in laptop .\n```\n$ trivy image [YOUR_IMAGE_NAME]\n\n\n$ trivy image python:3.4-alpine\n```\n\nOutput\n```\n2020-06-23T23:11:07.297+0530\tINFO\tDetecting Alpine vulnerabilities...\n\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 15 (UNKNOWN: 0, LOW: 1, MEDIUM: 10, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-15903   | MEDIUM   |                   | 2.2.7-r1      | expat: heap-based buffer       |\n|         |                  |          |                   |               | over-read via crafted XML      |\n|         |                  |          |                   |               | input                          |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   | HIGH     | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| openssl | CVE-2019-1543    | MEDIUM   | 1.1.1a-r1         | 1.1.1b-r1     | openssl: ChaCha20-Poly1305     |\n|         |                  |          |                   |               | with long nonces               |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1549    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in fork()           |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1551    |          |                   | 1.1.1d-r2     | openssl: Integer overflow in   |\n|         |                  |          |                   |               | RSAZ modular exponentiation on |\n|         |                  |          |                   |               | x86_64                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-1563    |          |                   | 1.1.1d-r0     | openssl: information           |\n|         |                  |          |                   |               | disclosure in PKCS7_dataDecode |\n|         |                  |          |                   |               | and CMS_decrypt_set1_pkey      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-1967    |          |                   | 1.1.1g-r0     | openssl: Segmentation fault in |\n|         |                  |          |                   |               | SSL_check_chain causes denial  |\n|         |                  |          |                   |               | of service                     |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-1547    | LOW      |                   | 1.1.1d-r0     | openssl: side-channel weak     |\n|         |                  |          |                   |               | encryption vulnerability       |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    | HIGH     | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+         +------------------+----------+                   +---------------+--------------------------------+\n|         | CVE-2019-16168   | MEDIUM   |                   | 3.28.0-r1     | sqlite: division by zero in    |\n|         |                  |          |                   |               | whereLoopAddBtreeIndex in      |\n|         |                  |          |                   |               | sqlite3.c                      |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-19242   |          |                   | 3.28.0-r2     | sqlite: SQL injection in       |\n|         |                  |          |                   |               | sqlite3ExprCodeTarget in       |\n|         |                  |          |                   |               | expr.c                         |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2019-5018    |          |                   | 3.28.0-r0     | sqlite: use-after-free in      |\n|         |                  |          |                   |               | window function leading to     |\n|         |                  |          |                   |               | remote code execution          |\n+         +------------------+          +                   +---------------+--------------------------------+\n|         | CVE-2020-11655   |          |                   | 3.28.0-r3     | sqlite: malformed              |\n|         |                  |          |                   |               | window-function query leads to |\n|         |                  |          |                   |               | DoS                            |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n```\n\n### Trivy Docker Run\n\nTrivy can be run from Docker.\n\n```\n$ docker run --rm -v [YOUR_CACHE_DIR]:/root/.cache/ aquasec/trivy [YOUR_IMAGE_NAME]\n\n$ docker run --rm -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy python:3.4-alpine\n```\n\n### Trivy Results as JSON\n\nTrivy output can be generated as json.\n\n```\n$ trivy image -f json -o results.json python:3.4-alpine\n```\n\n### Filter vulnerabilities by severities\n\nVulnerability results can be filtered. In the below example HIGH and CRITICAL issues are displayed\n\n```\n$ trivy image --severity HIGH,CRITICAL python:3.4-alpine\n```\n\n```\n\npython:3.4-alpine (alpine 3.9.2)\n================================\nTotal: 4 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 4, CRITICAL: 0)\n\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n| bzip2   | CVE-2019-12900   | HIGH     | 1.0.6-r6          | 1.0.6-r7      | bzip2: out-of-bounds write in  |\n|         |                  |          |                   |               | function BZ2_decompress        |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| expat   | CVE-2018-20843   |          | 2.2.6-r0          | 2.2.7-r0      | expat: large number of colons  |\n|         |                  |          |                   |               | in input makes parser consume  |\n|         |                  |          |                   |               | high amount...                 |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| musl    | CVE-2019-14697   |          | 1.1.20-r4         | 1.1.20-r5     | musl libc through 1.1.23       |\n|         |                  |          |                   |               | has an x87 floating-point      |\n|         |                  |          |                   |               | stack adjustment imbalance,    |\n|         |                  |          |                   |               | related...                     |\n+---------+------------------+          +-------------------+---------------+--------------------------------+\n| sqlite  | CVE-2019-8457    |          | 3.26.0-r3         | 3.28.0-r0     | sqlite: heap out-of-bound read |\n|         |                  |          |                   |               | in function rtreenode()        |\n+---------+------------------+----------+-------------------+---------------+--------------------------------+\n```\n\n### Trivy Run - Exit Code\n\nExit code can be used to break the build based on condition. \n\nThis is useful while using Trivy in CICD\n\n\n#### Stop Build\u000b\n\nBuild stops, when CRITICAL and HIGH severities are found.\n\n```\n$ trivy image --exit-code 1 --severity CRITICAL,HIGH python:3.4-alpine\n```\n\n\n#### Continue Build\u000b\n\nBuild doesn't stop, when MEDIUM and LOW found.\n\n```\n$ trivy image --exit-code 0 --severity MEDIUM,LOW python:3.4-alpine\n```\n\n\n## Integrating Trivy with Jenkins and Tekton`\n\nLets integrate the Trivy in `Jenkins` and `Tekton` pipelines of Cloud Native Toolkit\n\n- Create an App using [Deploy First App](/developer-intermediate/deploy-app).\n\n- Make changes to the `Jenkins` or `Tekton` pipelines as given below.\n\n<Tabs>\n<Tab label=\"Jenkins\">\n\nThe CICD process contains several steps. There is a step called `Build Image` that will build a image and Push the image to the image registry.\n![Jenkins Pipeline](/images/01-jenkins-pipeline.png)\n\nNeed to split the step into 3 steps.\n- Build Image\n- Trivy Scan\n- Push Image\n\nThe modified pipeline should look like this.\n![Jenkins Pipeline with Trivy](/images/02-jenkins-pipeline-with-trivy.png)\n\n#### Build Image\nThe build image will build the image.\n\n#### Trivy Scan\nTrivy scan will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue.\n\n#### Push Image\nAfter the scan is completed, it Pushes the image to the Image Registry.\n\n<BR></BR>\n<BR></BR>\n\nThe pipeline scripts are defined in the `jenkinsfile`. lets us see the changes done in the jenkins file.\n\n## Jenkinsfile Changes\n\n### Declaration\n\nThe below code snippet is the declaration about Trivy image, to be added in the `containers` section under `podTemplate` in the `jenkinsfile`\n\n    ```\n    - name: trivy\n        image: docker.io/aquasec/trivy\n        tty: true\n        command: [\"/bin/sh\"]\n        workingDir: ${workingDir}\n        securityContext:\n        privileged: true\n        envFrom:\n        - configMapRef:\n            name: ibmcloud-config\n        - secretRef:\n            name: ibmcloud-apikey       \n    ```\n\n1. `name`  -  `trivy` will be used in the script to refer the trivy container.\n2. `image` - image tag of the `trivy`.\n3. `configMapRef` -  A configmap contains `username` details to connect to IBM Cloud Container registry.\n4. `secretRef` A secrte contains `password` to connect to IBM Cloud Container registry.\n\n### Build Image\n\nHere are the steps to Build Image. Replace the existing content under the `container(name: 'buildah'`\n\n```\ncontainer(name: 'buildah', shell: '/bin/bash') {\n    stage('Build image') {\n        sh '''#!/bin/bash\n            set -e\n            . ./env-config\n\n            echo TLSVERIFY=${TLSVERIFY}\n            echo CONTEXT=${CONTEXT}\n        IMAGE_VERSION=\"0.0.1\"\n\n            if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n                REGISTRY_PASSWORD=\"${APIKEY}\"\n            fi\n\n        APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n        echo \"Image... $APP_IMAGE\"\n\n        buildah bud --tls-verify=${TLSVERIFY} --format=docker -f ${DOCKERFILE} -t ${APP_IMAGE} ${CONTEXT}\n\n        if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n            buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n        fi\n\n        buildah push --tls-verify=${TLSVERIFY} \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n        '''\n    }\n}\n```\n\n1. The variable `APP_IMAGE=` contains the Temp image name. \n\n2. Image is build using `buildah` and tagged with temp image name.\n\n3. Login into IBM Cloud Container Registry using `buildah`.\n\n4. Temp image is pushed to IBM Cloud Container Registry using `buildah`.\n\n\n### Trivy Scan\n\nThe below code snippet is for trivy Scanning. Add the below code under the previous step `Build Image'\n\n```\n        container(name: 'trivy', shell: '/bin/sh') {\n            stage('Trivy Scan') {\n\n                  sh '''#!/bin/sh\n\n                    set -e\n                    . ./env-config\n\n                    echo TLSVERIFY=${TLSVERIFY}\n                    echo CONTEXT=${CONTEXT}\n                    IMAGE_VERSION=\"0.0.1\"\n\n                    if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n                      REGISTRY_PASSWORD=\"${APIKEY}\"\n                    fi\n\n                    APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n                    export TRIVY_AUTH_URL=${REGISTRY_URL}\n                    export TRIVY_USERNAME=${REGISTRY_USER}\n                    export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n\n                    echo \"Trivy image scanning started.... $APP_IMAGE_Temp\"\n\n                    # Trivy scan\n                    trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}\n                    #trivy image ${APP_IMAGE_Temp}\n\n                    # Check scan results\n                    my_exit_code=$?\n                    echo \"scan exit code : $my_exit_code\"\n                    if [ ${my_exit_code} == 1 ]; then\n                        echo \"Image scanning failed. Some vulnerabilities found\"\n                        exit 1;\n                    else\n                        echo \"Image is scanned Successfully. No vulnerabilities found\"\n                    fi;\n                '''\n            }\n        }\n\n```\n\n1. The temporary image is scanned here.\n\n2. `TRIVY_AUTH_URL,` `TRIVY_USERNAME`, `TRIVY_PASSWORD` refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.\n\n3. `trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}` - step scans the temp image available in the IBM Cloud Container Registry.\n\n4. The step stops and then the pipeline also stops when there is a CRITICAL issue found.\n\n5. If you don't want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with `trivy ${APP_IMAGE_Temp}`.\n\n6. The scan results will be printed in the console.\n\n\n### Push Image\n\nThe below code snippet is for Pushing Image. Add the below code under the previous step `Trivy Scan'\n\n```\n        container(name: 'buildah', shell: '/bin/bash') {\n            stage('Push image') {\n                sh '''#!/bin/bash\n                    set -e\n                    . ./env-config\n\n\t\t            echo TLSVERIFY=${TLSVERIFY}\n\t\t            echo CONTEXT=${CONTEXT}\n                IMAGE_VERSION=\"0.0.1\"\n\n\t\t            if [[ -z \"${REGISTRY_PASSWORD}\" ]]; then\n\t\t              REGISTRY_PASSWORD=\"${APIKEY}\"\n\t\t            fi\n\n                APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}\"\n                APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n                if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n                    buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n                fi\n        \n                buildah pull ${APP_IMAGE_Temp}\n                buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n                buildah push --tls-verify=${TLSVERIFY} \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n                buildah rmi ${APP_IMAGE_Temp}\n                '''\n            }\n        }\n```\n\nThe code snippet does the followings.\n\n1. Login into IBM Cloud Container Registry using `buildah`.\n\n2. Pull the temp image using `buildah`.\n\n3. Tag the image to the actual image name.\n\n4. Push the actual image to IBM Cloud Container Registry using `buildah`.\n\n5. Remove the temp image from IBM Cloud Container Registry using `buildah`.\n\n</Tab>\n\n<Tab label=\"Tekton\">\n\nThe CICD process contains several steps. There is a step called `Build` that will build a image and Push the image to the image registry.\n\n![Tekton Pipeline](/images/05-tekton-pipeline.png)\n\nNeed to split the step into 3 steps.\n- image-build\n- image-scan-trivy\n- image-push\n\nThe modified pipeline should look like this.\n![Tekton Pipeline with Trivy](/images/06-tekton-pipeline-with-trivy.png)\n\n#### image-build\nThis step will build the image.\n\n#### image-scan-trivy\nThis step will scan the image and print the Vulnerability count as Low, Medium, High and Critical.\nBased on the configured exit criteria (0 Critical) the next step would in the pipeline will continue.\n\n#### image-push\nAfter the scan is completed, this step Pushes the image to the Image Registry.\n\n\nThe pipeline scripts are defined as Task in the yaml file. lets us see the changes done in the task file.\n\n## Tekton Task Changes\n\n\n### Extract the existing tekton task yaml\n\n1.Run the below command\n\n```\noc get tasks    \n```\n\nyou may get the output like this. The relvant task related to the build and push would be `igc-build-tag-push-v1-23-0`.\n\n\n```\nNAME                               AGE\nigc-build-tag-push-v1-23-0         52m\nigc-deploy-v1-23-0                 52m\nigc-gitops-v1-23-0                 52m\nigc-goland-test                    52m\nigc-gradle-pact-verify-v1-23-0     52m\nigc-health-check-v1-23-0           52m\nigc-helm-package-v1-23-0           52m\nigc-java-gradle-test-v1-23-0       52m\nigc-java-maven-test-v1-23-0        52m\nigc-liberty-server-check-v1-23-0   52m\nigc-nodejs-test-v1-23-0            52m\n```\n\n2.Run the below command to extract the task content into \n\n```\noc get tasks igc-build-tag-push-v1-23-0 -o yaml > igc-build-tag-push-v1-23-0.yaml\n```\n\n3.Update the `igc-build-tag-push-v1-23-0.yaml` file as per the given below steps.\n\n### Declaration\n\nAdd the below code code snippet as declaration about the Trivy image in the `Task`\n\n```\n    - default: docker.io/aquasec/trivy\n      name: trivy\n      type: string     \n```\n\n- After adding the Task code should be like this.\n- Replace the namespace `trivy-demo`, with your project namespace.\n\n```\napiVersion: tekton.dev/v1alpha1\nkind: Task\nmetadata:\n  name: igc-build-tag-push-v1-23-0\n  namespace: trivy-demo\n  labels:\n    version: 1.23.0\nspec:\n  inputs:\n    params:\n      - default: 'docker.io/node:12-stretch'\n        name: js-image\n        type: string\n      - default: 'quay.io/buildah/stable:v1.11.0'\n        name: BUILDER_IMAGE\n        type: string\n      - default: ./Dockerfile\n        name: DOCKERFILE\n        type: string\n      - default: docker.io/aquasec/trivy\n        name: trivy\n        type: string      \n      - default: .\n        name: CONTEXT\n        type: string\n      - default: 'false'\n        name: TLSVERIFY\n        type: string\n    resources:\n      - name: source\n        type: git\n  outputs:\n    resources:\n      - name: image\n        type: image\n```\n\n### Image Build\n\nReplace the content of the step 'build' with the below code snippet.\n\n```\n    - resources: {}\n      name: image-build\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n          . ./env-config\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n\n          buildah bud --tls-verify=$(inputs.params.TLSVERIFY) --format=docker -f $(inputs.params.DOCKERFILE) -t ${APP_IMAGE}  $(inputs.params.CONTEXT)\n\n          if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]];\n          then\n            buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n          fi\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) \"${APP_IMAGE}\" \"docker://${APP_IMAGE}\"\n\n```\n\n1. Temp image is build using `buildah`\n2. Login into IBM Cloud Container Registry using `buildah`.\n3. Temp image is pushed to IBM Cloud Container Registry using `buildah`.\n4. env `REGISTRY_USER` contains Username details to Login into IBM Cloud Container Registry.\n5. env `REGISTRY_PASSWORD` contains Password details to Login into IBM Cloud Container Registry.\n6. `name: build` refers the name of the step\n\n### Image Scan Trivy\n\nAdd the below code code snippet in the `Task` for trivy scanning.\n\n```\n    - resources: {}\n      name: image-scan-trivy\n      command:\n      - /bin/sh\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.trivy)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n\n          export TRIVY_AUTH_URL=${REGISTRY_URL}\n\n          export TRIVY_USERNAME=${REGISTRY_USER}\n\n          export TRIVY_PASSWORD=${REGISTRY_PASSWORD}\n    \n          echo \"Trivy image scanning...111. $APP_IMAGE\"\n    \n          # Trivy scan\n\n          trivy image ${APP_IMAGE}\n\n          #trivy image --exit-code 1 --severity CRITICAL ${APP_IMAGE}\n\n          echo \"Trivy image scanning...222. $APP_IMAGE\"\n\n          # Trivy scan result processing\n          \n          my_exit_code=$?\n\n          echo \"RESULT 1:--- $my_exit_code\"\n    \n          if [ ${my_exit_code} == 1 ]; then\n\n              echo \"Image scanning failed. Some vulnerabilities found\"\n\n              exit 1;\n          else\n              echo \"Image is scanned Successfully. No vulnerabilities found\"\n\n          fi;\n```\n\n1. The temporary image is scanned here.\n\n2. `TRIVY_AUTH_URL,` `TRIVY_USERNAME`, `TRIVY_PASSWORD` refers the Registry URL and user details to login into IBM Cloud Container Registry by trivy.\n\n3. `trivy --exit-code 1 --severity CRITICAL ${APP_IMAGE_Temp}` - step scans the temp image available in the IBM Cloud Container Registry.\n\n4. The step stops and then the pipeline also stops when there is a CRITICAL issue found.\n\n5. If you don't want to stop the pipeline though the CRITICAL issue is found then replace the above triy scan line with `trivy ${APP_IMAGE_Temp}`.\n\n6. The scan results will be printed in the console.\n\n\n### Image Push\n\nAdd the below code code snippet in the `Task` for pushing image.\n\n```\n     - resources: {}\n      name: image-push\n      command:\n        - /bin/bash\n      env:\n        - name: REGISTRY_USER\n          valueFrom:\n            secretKeyRef:\n              key: REGISTRY_USER\n              name: ibmcloud-apikey\n              optional: true\n        - name: REGISTRY_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              key: APIKEY\n              name: ibmcloud-apikey\n              optional: true\n      securityContext:\n        privileged: true\n      volumeMounts:\n        - mountPath: /var/lib/containers\n          name: varlibcontainers\n      image: $(inputs.params.BUILDER_IMAGE)\n      workingDir: $(inputs.resources.source.path)\n      args:\n        - '-c'\n        - >\n          set -e\n\n\n          . ./env-config\n\n\n          IMAGE_URL=$(outputs.resources.image.url)\n\n\n          REGISTRY_URL=$(echo $IMAGE_URL | awk -F / '{print $1}')\n\n          REGISTRY_NAMESPACE=$(echo $IMAGE_URL | awk -F / '{print $2}')\n\n          APP_IMAGE=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_VERSION}\"\n\n          APP_IMAGE_Temp=\"${REGISTRY_URL}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}-temp:${IMAGE_VERSION}\"\n    \n          if [[ -n \"${REGISTRY_USER}\" ]] && [[ -n \"${REGISTRY_PASSWORD}\" ]]; then\n              buildah login -u \"${REGISTRY_USER}\" -p \"${REGISTRY_PASSWORD}\" \"${REGISTRY_URL}\"\n          fi\n    \n          buildah pull ${APP_IMAGE_Temp}\n\n          buildah tag ${APP_IMAGE_Temp} ${APP_IMAGE}\n\n          buildah push --tls-verify=$(inputs.params.TLSVERIFY) \"${APP_IMAGE}\"  \"docker://${APP_IMAGE}\"\n\n          buildah rmi ${APP_IMAGE_Temp}\n```\n\nThe code snippet does the followings.\n\n1. Login into IBM Cloud Container Registry using `buildah`.\n\n2. Pull the temp image using `buildah`.\n\n3. Tag the image to the actual image name.\n\n4. Push the actual image to IBM Cloud Container Registry using `buildah`.\n\n5. Remove the temp image from IBM Cloud Container Registry using `buildah`.\n\n\n### Push the pipeline changes\n\nRun the below command to apply the pipeline changes back to the cluster.\n```\noc apply -f igc-build-tag-push-v1-23-0.yaml\n```\n\n\n</Tab>\n\n</Tabs>\n","fileAbsolutePath":"/Users/vishal/Cloud2020/CNTK/ibm-gsi-cloudnative-journey/src/pages/developer-advanced/devsecops-trivy/index.mdx"}}}}